/*
 * European scorekeeper tool
 * Copyright (C) 2020  Patrick BRIAND
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * generated by Xtext 2.23.0
 *
 */
package org.bpy.score.club.util;

import java.io.ByteArrayInputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.bpy.score.club.ClubStandaloneSetup;
import org.bpy.score.club.club.Club;
import org.bpy.score.club.club.ClubDescription;
import org.bpy.score.club.club.ClubFactory;
import org.bpy.score.club.club.Member;
import org.bpy.score.club.club.Player;
import org.bpy.score.club.club.ScoreKeeper;
import org.bpy.score.club.club.Team;
import org.bpy.score.club.club.Umpire;
import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.IFolder;
import org.eclipse.core.resources.IResource;
import org.eclipse.core.runtime.CoreException;
import org.eclipse.core.runtime.NullProgressMonitor;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.common.util.TreeIterator;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.eclipse.ui.IWorkbenchPage;
import org.eclipse.ui.PlatformUI;
import org.eclipse.ui.ide.IDE;
import org.eclipse.xtext.resource.XtextResourceSet;

import com.google.inject.Inject;
import com.google.inject.Injector;

/**
 * Allow to retrieve information about a club
 */
public class ClubDataParser {
	
	/** It is the logger of the class */
	public static final Logger logger = Logger.getLogger(ClubDataParser.class.getSimpleName());

	/** End of line with "*/ 
	public static final String END_OF_LINE_WITH_COMMA = "\";\r\n"; //$NON-NLS-1$
	
	/** Google injector for the XText resources*/
	@Inject 
	Injector injector;
	
	/** XText resource set */
	private XtextResourceSet resourceSet;

	/** List of members */
	private List<Member> members;
	/** List of scoreKeeper */
	private List<Member> scoreKeepers;
	/** List of umpire */
	private List<Member> umpires;

	/** List of clubs */
	private List<Club> clubs; 

	/** Collection of categories with there members */
	private HashMap<String, List<Member>> categories;
	/** Collection of members by teams and categories */
	private HashMap<String, List<String>> membersByTeamsAndCategory; 

	/** Club name */
	private String clubName;
	/** City name */
	private String cityName;

	/**
	 * Constructor of the class.
	 * This constructor initialize the file and all local containers
	 */
	public ClubDataParser() {
		injector = new ClubStandaloneSetup().createInjectorAndDoEMFRegistration();
		injector.injectMembers(this);
		resourceSet = injector.getInstance(XtextResourceSet.class);

		members = new ArrayList<>();
		scoreKeepers = new ArrayList<>();
		umpires = new ArrayList<>();
		members = new ArrayList<>();
		categories = new HashMap<>();
	}
	
	/**
	 * This method allow to search all clubs which participate to a category 
	 * 
	 * @param currentCategory name of the category 
	 * 
	 * @return a list of clubs which participate to the category 
	 */
	public List<Club> getDeclaredTeamsForCategory(String currentCategory) {
		List<Club> clubsForTeamsAndCategories = new ArrayList<>();

		for (Resource resource :  resourceSet.getResources()) {
			TreeIterator<EObject> contents = resource.getAllContents();
			while (contents.hasNext()) {
				EObject content = contents.next();
				if (content instanceof Team) {
					Team team = (Team) content;
					if (currentCategory.equals(team.getName())) {
						clubsForTeamsAndCategories.add((Club) team.eContainer().eContainer());
					}
				}
			}
		}
		return clubsForTeamsAndCategories;
	}

	/**
	 * Create a new member.
	 * 
	 * @param name Name of member
	 * @param licenceNumber License number of the member 
	 * @param shortName short name of the member

	 * @return reference on a member rule
	 */
	public Member createNewMember(String name, String licenceNumber, String shortName) {
		Member member = ClubFactory.eINSTANCE.createMember();
		member.setName(name);
		member.setLicenceNumber(licenceNumber);
		member.setShortName(shortName);
		return member; 
	}

	/**
	 * Return the list of score keepers.
	 * 
	 * @return list of score keepers
	 */
	public List<Member> getScoreKeepers() {
		return scoreKeepers;
	}

	/**
	 * Add a score keeper in the collection.
	 * 
	 * @param scoreKeeper score keeper to add
	 */
	public void addScoreKeepers(Member scoreKeeper) {
		scoreKeepers.add(scoreKeeper);
	}

	/**
	 * Return the list of umpires.
	 * 
	 * @return list of umpires
	 */
	public List<Member> getUmpires() {
		return umpires;
	}

	/**
	 * Add an umpire in the collection.
	 * 
	 * @param umpire umpire to add
	 */
	public void addUmpire(Member umpire) {
		umpires.add(umpire);
	}

	/**
	 * Return the list of members.
	 * 
	 * @return list of members
	 */
	public List<Member> getMembers() {
		return members;
	}

	/**
	 * Add an member in the collection.
	 * 
	 * @param member member to add
	 */
	public void addMember(Member member) {
		members.add(member);
	}

	/**
	 * Get the categories collection
	 * 
	 * @return map which contains categories collection
	 */
	public Map<String, List<Member>> getCategories() {
		return categories;
	}

	/**
	 * get the list of clubs
	 * 
	 * @return List of clubs
	 */
	public List<Club> getClubs() {
		return clubs;
	}

	/**
	 * Get a category description
	 * 
	 * @param categoryName Name of the category 
	 * @return a category if exists, <b>null</b> otherwise
	 */
	public List<Member> getCategory(String categoryName) {
		if (categories.containsKey(categoryName)) {
			return categories.get(categoryName);

		} else {
			List<Member> membersForCategory = new ArrayList<>();
			categories.put(categoryName, membersForCategory);
			return membersForCategory;
		}
	}

	/**
	 * Get name of the city.
	 *  
	 * @return name of the city
	 */
	public String getCityName() {
		return cityName;
	}

	/**
	 * Get name of the club.
	 *  
	 * @return name of the blub
	 */
	public String getClubName() {
		return clubName;
	}

	/**
	 * Set the city name.
	 * 
	 * @param cityName city name
	 */
	public void setCityName(String cityName) {
		this.cityName = cityName;
	}

	/**
	 * Set the club name.
	 * 
	 * @param clubName club name
	 */
	public void setClubName(String clubName) {
		this.clubName = clubName;
	}

	/**
	 * Return the list of club resources
	 * 
	 * @return list of club resources
	 */
	public List<Resource> getClubsDescription() {
		return resourceSet.getResources();
	}

	/**
	 * Return the list of players in a category.
	 * 
	 * @param folder folder which contains the clubs description
	 * @param teamName Name of the team 
	 * @param compName category name
	 * 
	 * @return list of players
	 */
	public List<String> getPlayersInTeam(IFolder folder, String teamName, String compName) {
		List<String> players = new ArrayList<>();
		if (membersByTeamsAndCategory == null) {
			membersByTeamsAndCategory = new HashMap<>();
		}
		
		String key = teamName+ ":" + compName; //$NON-NLS-1$
		if (membersByTeamsAndCategory.containsKey(key)) {
			return membersByTeamsAndCategory.get(key);
		} else {
		
			try {
				for (IResource resource : folder.members()) {
						
					manageClubResource(resource);
					
					if (resource instanceof IFile) {
						if ((resource.getFileExtension() != null) && resource.getFileExtension().equalsIgnoreCase("club")) { //$NON-NLS-1$
							URI modelURI = URI.createPlatformResourceURI(resource.getFullPath().toString(), true);
							Resource xtextResource = resourceSet.getResource(modelURI, true);
				
							EcoreUtil.resolveAll(xtextResource);
				
							EList<EObject> contents = xtextResource.getContents();
							for (EObject content : contents) {
				
								if (content instanceof Club) {
									Club club = (Club)content;
									ClubDescription description = club.getClubDescription();
									if (description.getName().equals(teamName)) {
										for (Team team : description.getTeams()) {
											if (team.getName().equals(compName)) {
												for (Player player : team.getPlayers()) {
													players.add(player.getPlayerName().getName());
												}	
												membersByTeamsAndCategory.put(key,players);
												return players;
											}
										}
									}
								}
							}
						}
					}
				}
			} catch (CoreException e) {
				logger.log(Level.SEVERE, e.getLocalizedMessage());
			}
		}
		return players;
	}

	private void manageClubResource(IResource resource) {
		// Nothing to here
	}

	/**
	 * Parse all club file in a folder.
	 * 
	 * @param folder reference to a folder
	 */
	public void parseData(IFolder folder) {
		clubs = new ArrayList<>();
		
		try {
			for (IResource member : folder.members()) {

				if (member instanceof IFile) {
					parseData((IFile)member);
				}
			}
		} catch (CoreException e) {
			logger.log(Level.SEVERE, e.getLocalizedMessage());
		}
	}

	/**
	 * Parse data in a club file description.
	 * 
	 * @param iFile reference to file
	 */
	public void parseData(IFile iFile) {
		if ((iFile.getFileExtension() != null) && iFile.getFileExtension().equalsIgnoreCase("club")) { //$NON-NLS-1$

			URI modelURI = URI.createPlatformResourceURI(iFile.getFullPath().toString(), true);
			Resource xtextResource = resourceSet.getResource(modelURI, true);

			EcoreUtil.resolveAll(xtextResource);

			TreeIterator<EObject> contents = xtextResource.getAllContents();
			while (contents.hasNext()) {
				EObject content = contents.next();

				manageContent(content);
				
			}
		}
	}

	/**
	 * Manage the content of a club file
	 * 
	 * @param content reference to the content
	 */
	private void manageContent(EObject content) {
		if (content instanceof Club) {
			if (null == clubs) {
				clubs = new ArrayList<>();
			}
			clubs.add((Club) content);
		}

		if (content instanceof ScoreKeeper) {
			Member name = ((ScoreKeeper)content).getName();
			addPerson(scoreKeepers, name);

		} else if (content instanceof Umpire) {
			Member name = ((Umpire)content).getName();
			addPerson(umpires, name);

		} else if (content instanceof Member) {
			addPerson(members, (Member)content);

		} else if (content instanceof Team) {
			addCategory(categories,(Team) content);

		} else if (content instanceof Club) {
			clubName = ((Club)content).getName();

		} else if (content instanceof ClubDescription) {
			cityName = ((ClubDescription)content).getName();
		}
	}

	/**
	 * Add a team to a category.
	 * 
	 * @param map reference to a category
	 * @param team team to add
	 */
	private void addCategory(HashMap<String, List<Member>> map, Team team) {
		List<Member> players = new ArrayList<>();

		map.put(team.getName(), players);

		for (Player player : team.getPlayers()) {
			players.add(player.getPlayerName());
		}
	}

	/**
	 * Add a member in a collection of member.
	 * 
	 * @param container Reference to the member collection
	 * @param member member to add to the collection
	 */
	private void addPerson(List<Member> container, Member member) {
		if (!container.contains(member)) {
			container.add(member);
		}
	}

	/**
	 * Export a club description in a file.
	 * 
	 * @param rootFolder where to export the file
	 */
	public void exportAsFile(IFolder rootFolder) {
		StringBuilder strBuffer = new StringBuilder("club \"" + getClubName() + "\" {\r\n"); //$NON-NLS-1$ //$NON-NLS-2$
		strBuffer.append("\tcity = \"" + getCityName() + "\";\r\n\r\n"); //$NON-NLS-1$ //$NON-NLS-2$
		strBuffer.append("\tmembers {\r\n"); //$NON-NLS-1$
		for (Member member : getMembers()) {
			strBuffer.append("\t\tmember name = \"" + member.getName() + "\""); //$NON-NLS-1$ //$NON-NLS-2$
			if (member.getShortName() != null && !"".equals(member.getShortName())) { //$NON-NLS-1$
				strBuffer.append(" shortName = \"" + member.getShortName() + "\""); //$NON-NLS-1$ //$NON-NLS-2$
			}
			strBuffer.append(" licenceNumber = \"" + member.getLicenceNumber() + "\""); //$NON-NLS-1$ //$NON-NLS-2$
			strBuffer.append(";\r\n"); //$NON-NLS-1$
			
		}
		strBuffer.append("\t}\r\n"); //$NON-NLS-1$
		strBuffer.append("\r\n"); //$NON-NLS-1$

		exportCategories(strBuffer);
		exportOfficials(strBuffer);

		strBuffer.append("}\r\n"); //$NON-NLS-1$

		IFile clubFile = rootFolder.getFile(getClubName() + ".club"); //$NON-NLS-1$
		if (!clubFile.exists()) {
			try {
				clubFile.create(new ByteArrayInputStream(strBuffer.toString().getBytes()), true,
					new NullProgressMonitor());

				IWorkbenchPage page = PlatformUI.getWorkbench().getActiveWorkbenchWindow().getActivePage();
				IDE.openEditor(page, clubFile);

			} catch (CoreException e) {
				logger.log(Level.SEVERE, e.getLocalizedMessage());
			}
		}
	}

	/**
	 * Export the officials in the String builder
	 * 
	 * @param strBuffer reference to the StringBuilder
	 */
	private void exportOfficials(StringBuilder strBuffer) {
		if (!scoreKeepers.isEmpty() || !umpires.isEmpty() ) {
			strBuffer.append("\tofficials {\r\n"); //$NON-NLS-1$
			
			for (Member scoreKeeper : scoreKeepers) {
				strBuffer.append("\t\tscoreKeeper name = \"" + scoreKeeper.getName() + END_OF_LINE_WITH_COMMA); //$NON-NLS-1$
			}
			for (Member umpire : umpires) {
				strBuffer.append("\t\tumpire name = \"" + umpire.getName() + END_OF_LINE_WITH_COMMA); //$NON-NLS-1$
			}
			
			strBuffer.append("\t}"); //$NON-NLS-1$
			strBuffer.append("\r\n"); //$NON-NLS-1$
		}
	}

	/**
	 * Export categories in the String builder
	 * 
	 * @param strBuffer reference to the StringBuilder
	 */
	private void exportCategories(StringBuilder strBuffer) {
		if (!categories.isEmpty()) {
			for (Entry<String, List<Member>> catgoryEntry : categories.entrySet()) {
				strBuffer.append("\tteam \"" + catgoryEntry.getKey() +"\" {\r\n"); //$NON-NLS-1$ //$NON-NLS-2$
				for (Member member : catgoryEntry.getValue()) {
					strBuffer.append("\t\tplayer name = \"" + member.getName() + END_OF_LINE_WITH_COMMA); //$NON-NLS-1$
				}									
				strBuffer.append("\t}\r\n"); //$NON-NLS-1$
				strBuffer.append("\r\n"); //$NON-NLS-1$
			}	
		}
	}
}
