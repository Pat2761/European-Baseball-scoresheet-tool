/*
 * European scorekeeper tool
 * Copyright (C) 2020  Patrick BRIAND
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * generated by Xtext 2.23.0
 *
 */
package org.bpy.score.club.ui.contentassist;

import java.util.List;
import java.util.ArrayList;
import java.util.Collections;

import org.bpy.score.club.club.ClubDescription;
import org.bpy.score.club.club.Member;
import org.bpy.score.club.club.Official;
import org.bpy.score.club.club.Officials;
import org.bpy.score.club.club.Player;
import org.bpy.score.club.club.ScoreKeeper;
import org.bpy.score.club.club.Team;
import org.bpy.score.club.club.Umpire;
import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.xtext.RuleCall;
import org.eclipse.xtext.ui.editor.contentassist.ContentAssistContext;
import org.eclipse.xtext.ui.editor.contentassist.ICompletionProposalAcceptor;

/**
 * See https://www.eclipse.org/Xtext/documentation/310_eclipse_support.html#content-assist
 * on how to customize the content assistant.
 */
public class ClubProposalProvider extends AbstractClubProposalProvider {
	
	/** 
	 * Allow to create a new member in the members list.
	 * 
	 * @param model reference to the model
	 * @param ruleCall reference to the rule
	 * @param context reference to the context
	 * @param acceptor reference to the acceptor
	 */
	@Override
	public void complete_Member(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		acceptor.accept(createCompletionProposal("member name = \"\" licenceNumber = \"\";\n",
		"Add a new member to the club", null, context));
	}

	/**
	 * Supply a list of player to add to a category.
	 * 
	 * @param model reference to the model
	 * @param ruleCall reference to the rule
	 * @param context reference to the context
	 * @param acceptor reference to the acceptor
	 */
	@Override
	public void complete_Player(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		Team team = (Team)model;
		List<String >playersInTheTeam = new ArrayList<>();

		for (Player player : team.getPlayers()) {
			playersInTheTeam.add(player.getPlayerName().getName());
		}

		ClubDescription clubDescription = (ClubDescription)team.eContainer();
		for (Member member : clubDescription.getMembers().getMembers()) {
			if (!playersInTheTeam.contains(member.getName())) {

				acceptor.accept(createCompletionProposal("player name = \"" + member.getName() + "\";\n",
				"Add a "+ member.getName() +" to the team", null, context));
			}
		}
	}
	
	/**
	 * Supply a list of player to add to the officials.
	 * 
	 * @param model reference to the model
	 * @param ruleCall reference to the rule
	 * @param context reference to the context
	 * @param acceptor reference to the acceptor
	 */
	@Override
	public void complete_Official(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		Officials officials = (Officials)model;
		
		ArrayList<String> scoreKeepers = new ArrayList<>();
		ArrayList<String> umpires = new ArrayList<>();

		for (Official official : officials.getOfficials()) {
			if (official instanceof ScoreKeeper) {
				ScoreKeeper scoreKeeper = (ScoreKeeper) official;
				scoreKeepers.add(scoreKeeper.getName().getName());
			} else if (official instanceof Umpire) {
				Umpire umpire = (Umpire) official;
				umpires.add(umpire.getName().getName()); 
			}
		}
		
		ClubDescription club = (ClubDescription)model.eContainer();
 		if (context.getPrefix().startsWith("s")) {
			List<String> possibleScoreKeepers = getPossibleMembers(club.getMembers().getMembers(), scoreKeepers);
			accept(acceptor, "scoreKeeper",possibleScoreKeepers,context);
			

		} else if (context.getPrefix().startsWith("u")) {
			List<String> possibleUmpires = getPossibleMembers(club.getMembers().getMembers(),umpires);
			accept(acceptor, "umpire", possibleUmpires,context);

		} else {
			List<String> possibleScoreKeepers = getPossibleMembers(club.getMembers().getMembers(), scoreKeepers);
			accept(acceptor, "scoreKeeper",possibleScoreKeepers,context);
			
			List<String> possibleUmpires = getPossibleMembers(club.getMembers().getMembers(), umpires);
			accept(acceptor, "umpire", possibleUmpires,context);
		}
	}
	
	/**
	 * Add all possibles umpires or score keeper 
	 * 
	 * @param acceptor reference to the acceptor
	 * @param role role (Score keeper or umpire)
	 * @param possibleMembers list of possible members
	 * @param context  reference to the context
	 */
	private void accept(ICompletionProposalAcceptor acceptor, String role, List<String> possibleMembers, ContentAssistContext context) {
		Collections.sort(possibleMembers);
		
		for (String possibleMember : possibleMembers) {
			acceptor.accept(createCompletionProposal(role  + " name=\"" + possibleMember + "\";\n",
							"define " + possibleMember + " as " + role,null,context));
		}
	}
	
	/**
	 * Get the list of possible members. 
	 * the list of possible member exclude all the members already defined 
	 * 
	 * @param members List of members 
	 * @param membersAllRedayDefined List of members already defined
	 * 
	 * @return a list of possible members
	 */
	private List<String> getPossibleMembers(EList<Member> members, ArrayList<String> membersAllRedayDefined) {
		List<String> possiblesMembers = new ArrayList<>();
		for (Member member : members) {
			if (!membersAllRedayDefined.contains(member.getName()) ) {
				possiblesMembers.add(member.getName());
			}
		}
		
		return possiblesMembers;
	}
}
